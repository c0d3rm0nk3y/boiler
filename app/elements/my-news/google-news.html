<link rel="import" href="../../bower_components/google-feeds/google-feeds.html">

<dom-module id="google-news">
  <style></style>
  <template>
    <google-feeds id="_gf"></google-feeds>
  </template>
  <!-- socket.io script below, this thing allows us to talk to nodejs server 
       and process articles and look for patterns -->
  <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script> 
  <script src="he.js"></script>
  <script>
    (function() {
      Polymer({
        is: 'google-news',

        properties: {
          Topics: {
            readOnly: true,
            type: Array
          },
          Articles: {
            notify: true,
            readOnly: true,
            type: Array,
            value: []
          },
          GetTopic: { 
            notify: true,
            type: String,
            observer: '_getTopic()'
          },
          Search: {
            notify: true,
            type: String,
            observer: '_search()'
          },
          autoConnect: {
            notify: false,
            type: Boolean,
            value: false
          },
          Status: {
            notify: true,
            type: String,
            value: "all is well..."
          }
        },

        _getTopic: function(oVal, nVal) {
          // here we will build the url based on new topic, tossing error if topic not found
          // this really shouldn't be a problem though, as the GUI side will use the Topics provided
          // as what gets passed in.

          if(this.Topics.indexOf(nVal) > -1) {
            console.log('topic %s found!', nVal);
            this.status = "Topic Found, prepping...";
            var bUrl = "https://news.google.com/news?cf=all&hl=en&pz=1&ned=us&output=rss";
            switch(nVal) {
              case 'Top Stories':
                // use base url
                break;
              case 'World': 
                bUrl += "&topic=w";
                break;
              case 'US': 
                bUrl += "&topic=n";
                break;
              case 'Science': 
                bUrl += "&topic=snc";
                break;
              case 'Tech': 
                bUrl += "&topic=tc";
                break;
              case 'Spotlight': 
                bUrl += "&topic=ir";
                break;
              default: break;
            }
            this.status = "URL format complete, sending to google feed api.. ";
            this.$._gf.feed = bUrl;
          } else {
            console.log('topic %s not found..', nVal);
          }
        }, 

        _gup: function( name, link ) {
          name        = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
          var regexS  = "[\\?&]"+name+"=([^&#]*)";
          var regex   = new RegExp( regexS );
          var results = regex.exec( link );
          if(results === null) return null;
          else                 return results[1];
        },

        _gResponse: function(data) {
          console.log('<google-news>\n\tgoogle-feeds-resonse()\n\t\tResponse recieved from google feed api, processing now...')
          this.status = "Response recieved from google feed api, processing now...";
          if(data !== undefined) {
            this.articles = data.detail.feed.entries; // clear out the existing articles
            this.articles.forEach(function(e, i, a) { 
              a[i].link = this._gup('url', a[i].link); 
              a[i].content = he.decode(a[i].content);
              a[i].contentSnippet = he.decode(a[i].contentSnippet);
            });
            console.log(JSON.stringify(this.articles));
            // var entries = data.detail.feed.entries;
          }
        },

        _search: function(oVal, nVal) {
          // here we will build a custom news.google.com url to pull down a list of stories based on
          // the nVal, ie the keywords.
          
        },
        
        created: function() { this.Topics = [ 'Top Stories', 'World','US','Science','Tech','Spotlight' ]; },

        ready: function() { console.log('google-news element\n\tAll boards showing green.'); },

        attached: function() { window.addEventListener('google-feeds-response', this._gResponse.bind(this)); },
      });
    })();
  </script> 
</dom-module>